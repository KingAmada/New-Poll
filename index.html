<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2027 Nigeria Election Poll (Gamified) — Sheets Connected</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>

  <style>
    :root { --bg:#0b1220; --card:#101a30; --text:#eaf0ff; --muted:#9fb0d0; --line:#1d2b4c; --good:#21c07a; --bad:#ff5b6b; }
    body { margin:0; font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#070b14,#0b1220); color:var(--text); }
    header { padding:18px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter:blur(10px); z-index:10; }
    header h1 { margin:0; font-size:16px; letter-spacing:.2px; }
    header p { margin:6px 0 0; color:var(--muted); font-size:12px; }

    .wrap { max-width:1100px; margin:0 auto; padding:18px 16px 60px; }
    .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media (max-width: 980px){ .grid { grid-template-columns:1fr; } }

    .card { background:rgba(16,26,48,.9); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 10px; font-size:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea {
      width:100%;
      background:#0b152a;
      border:1px solid #24385f;
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
      font-size:13px;
    }
    textarea { min-height:90px; resize:vertical; }
    .field { flex: 1 1 200px; min-width:200px; }
    .btn {
      background:#1f3b76;
      border:1px solid #2d4f93;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn:active { transform:translateY(1px); }
    .btn.good { background:#118a57; border-color:#22c07a; }
    .btn.bad { background:#7a1a2a; border-color:#ff5b6b; }
    .mini { font-size:12px; color:var(--muted); line-height:1.4; }
    .status { font-size:12px; margin-top:10px; padding:10px; border-radius:10px; border:1px dashed #2a3e66; color:var(--muted); }
    .status strong { color:var(--text); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3e66; color:var(--muted); font-size:11px; }

    .divider { height:1px; background:var(--line); margin:12px 0; }
    .kpi { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media (max-width:680px){ .kpi { grid-template-columns:1fr; } }
    .kpi .box { padding:10px; border-radius:12px; border:1px solid #24385f; background:#0a1327; }
    .kpi .box .v { font-size:16px; font-weight:800; margin-top:6px; }
  </style>
</head>

<body>
<header>
  <h1>2027 Nigeria Election Poll (Gamified) — Connected to Google Sheets</h1>
  <p>Every action can be saved as an event. New fields automatically become new columns in your Sheet.</p>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>Quick Vote Capture</h2>

      <div class="row">
        <div class="field">
          <label>Voter Name (optional)</label>
          <input id="voterName" placeholder="e.g. Sarki" />
        </div>
        <div class="field">
          <label>Phone (optional)</label>
          <input id="voterPhone" placeholder="e.g. 080..." />
        </div>
        <div class="field">
          <label>State</label>
          <select id="state">
            <option value="">Select State</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>Candidate</label>
          <select id="candidate">
            <option value="">Select Candidate</option>
          </select>
        </div>

        <div class="field">
          <label>Party</label>
          <select id="party">
            <option value="">Select Party</option>
          </select>
        </div>

        <div class="field">
          <label>Vote Weight (optional)</label>
          <input id="weight" type="number" value="1" min="1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field" style="flex:1 1 100%;">
          <label>Note (optional)</label>
          <input id="note" placeholder="Any small context..." />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn good" id="btnVote">Save Vote</button>
        <button class="btn" id="btnSpin">Simulate Spin Round</button>
        <button class="btn bad" id="btnFlush">Flush Offline Queue</button>
        <span class="pill" id="queuePill">Queue: 0</span>
      </div>

      <div class="status" id="statusBox">
        <strong>Status:</strong> Ready.
      </div>

      <div class="divider"></div>

      <div class="mini">
        This page posts to your Apps Script Web App. If a user is offline or the request fails,
        data is queued and retried later.
      </div>
    </div>

    <div class="card">
      <h2>Dashboard KPIs (Local)</h2>
      <div class="kpi">
        <div class="box">
          <div class="mini">Local votes saved (this device)</div>
          <div class="v" id="kVotes">0</div>
        </div>
        <div class="box">
          <div class="mini">Local spin rounds</div>
          <div class="v" id="kSpins">0</div>
        </div>
        <div class="box">
          <div class="mini">Last event id</div>
          <div class="v" id="kLast" style="font-size:12px; font-weight:700; word-break:break-all;">-</div>
        </div>
      </div>

      <div class="divider"></div>

      <h2>State Result Update (Example)</h2>
      <div class="row">
        <div class="field">
          <label>State</label>
          <select id="state2">
            <option value="">Select State</option>
          </select>
        </div>
        <div class="field">
          <label>Candidate</label>
          <select id="candidate2">
            <option value="">Select Candidate</option>
          </select>
        </div>
        <div class="field">
          <label>Votes (state total)</label>
          <input id="stateVotes" type="number" value="0" min="0" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnStateSave">Save State Result</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        You can call <b>saveStateResult(state, candidate, votes)</b> directly from your map click logic.
      </div>
    </div>
  </div>
</div>

<script>
  /* -------------------- CONFIG -------------------- */

  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxyQF5LLJO0EmWeF18SreySreID9XghpDij8qERxgyblubPF_9Jb-W0N4_BJa72vdNsHA/exec";

  // Local storage keys
  const LS_QUEUE = "poll_offline_queue_v1";
  const LS_KPI   = "poll_local_kpi_v1";
  const LS_SESSION = "poll_session_id_v1";

  /* -------------------- SAMPLE DATA (edit freely) -------------------- */

  // You can replace these with your real candidate list, parties, etc.
  const CANDIDATES = [
    { id: "cand_001", name: "Candidate A" },
    { id: "cand_002", name: "Candidate B" },
    { id: "cand_003", name: "Candidate C" }
  ];

  const PARTIES = [
    { id: "pty_001", code: "AAA", name: "Alpha Alliance" },
    { id: "pty_002", code: "BBB", name: "Blue Bloc" },
    { id: "pty_003", code: "CCC", name: "Citizen Coalition" }
  ];

  // Full Nigeria states list
  const STATES = [
    "Abia","Adamawa","Akwa Ibom","Anambra","Bauchi","Bayelsa","Benue","Borno","Cross River","Delta","Ebonyi","Edo",
    "Ekiti","Enugu","FCT","Gombe","Imo","Jigawa","Kaduna","Kano","Katsina","Kebbi","Kogi","Kwara","Lagos","Nasarawa",
    "Niger","Ogun","Ondo","Osun","Oyo","Plateau","Rivers","Sokoto","Taraba","Yobe","Zamfara"
  ];

  /* -------------------- UTILITIES -------------------- */

  function uid(prefix="evt") {
    return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  function nowISO() {
    return new Date().toISOString();
  }

  function getSessionId() {
    let s = localStorage.getItem(LS_SESSION);
    if (!s) {
      s = uid("sess");
      localStorage.setItem(LS_SESSION, s);
    }
    return s;
  }

  function getKpi() {
    try { return JSON.parse(localStorage.getItem(LS_KPI)) || { votes:0, spins:0, last:"-" }; }
    catch(e){ return { votes:0, spins:0, last:"-" }; }
  }

  function setKpi(kpi) {
    localStorage.setItem(LS_KPI, JSON.stringify(kpi));
    renderKpi();
  }

  function renderKpi() {
    const k = getKpi();
    document.getElementById("kVotes").textContent = k.votes || 0;
    document.getElementById("kSpins").textContent = k.spins || 0;
    document.getElementById("kLast").textContent  = k.last || "-";
  }

  function setStatus(msg, ok=true) {
    const box = document.getElementById("statusBox");
    box.innerHTML = `<strong>Status:</strong> ${msg}`;
    box.style.borderColor = ok ? "#2a3e66" : "#7a1a2a";
    box.style.color = ok ? "var(--muted)" : "var(--bad)";
  }

  function getQueue() {
    try { return JSON.parse(localStorage.getItem(LS_QUEUE)) || []; }
    catch(e){ return []; }
  }

  function setQueue(q) {
    localStorage.setItem(LS_QUEUE, JSON.stringify(q));
    document.getElementById("queuePill").textContent = `Queue: ${q.length}`;
  }

  function queueEvent(payload) {
    const q = getQueue();
    q.push(payload);
    setQueue(q);
  }

  function isOnline() {
    return navigator.onLine !== false;
  }

  /* -------------------- CORE: SEND TO SHEETS -------------------- */
  /**
   * Sends event(s) to your Apps Script.
   * - type becomes the sheet tab name
   * - data can be object or array of objects
   * Robustness:
   * - queues on failure
   * - attempts flush on regain connectivity
   */
  async function sendToSheets(type, data, opts = {}) {
    const payload = {
      type: type || "RawEvents",
      data,
      meta: {
        ts: nowISO(),
        event_id: uid("evt"),
        session_id: getSessionId(),
        user_agent: navigator.userAgent,
        page: location.href,
        referrer: document.referrer || "",
        ip_hint: "", // browser can't read real IP; keep blank or pass your own if you have it
      }
    };

    // Merge meta into each record so it becomes columns
    payload.data = normalizeRecords(payload.data).map(r => ({ ...payload.meta, ...r }));

    const doQueueOnly = opts.queueOnly === true;

    if (doQueueOnly || !isOnline()) {
      queueEvent(payload);
      setStatus(`Offline. Queued event: ${payload.meta.event_id}`, false);
      bumpLast(payload.meta.event_id);
      return { queued: true, event_id: payload.meta.event_id };
    }

    // Try normal fetch first. If CORS blocks, fallback to no-cors fire-and-forget.
    try {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        // Use text/plain to avoid preflight in most cases
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      // If browser blocks reading (CORS), res may still exist but unreadable; we still treat as "sent".
      // We'll attempt to parse if possible.
      let out = null;
      try { out = await res.json(); } catch(e) {}

      setStatus(`Saved to Sheets (attempted). Event: ${payload.meta.event_id}`, true);
      bumpLast(payload.meta.event_id);
      return { ok: true, event_id: payload.meta.event_id, response: out };

    } catch (err) {
      // Fallback: no-cors (opaque response but usually delivers)
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        setStatus(`Sent (no-cors). Event: ${payload.meta.event_id}`, true);
        bumpLast(payload.meta.event_id);
        return { ok: true, event_id: payload.meta.event_id, noCors: true };

      } catch (err2) {
        queueEvent(payload);
        setStatus(`Failed. Queued event: ${payload.meta.event_id}`, false);
        bumpLast(payload.meta.event_id);
        return { queued: true, event_id: payload.meta.event_id, error: String(err2) };
      }
    }
  }

  function normalizeRecords(data) {
    if (Array.isArray(data)) return data.map(x => (typeof x === "object" && x !== null) ? x : { value: String(x) });
    if (typeof data === "object" && data !== null) return [data];
    return [{ value: String(data) }];
  }

  function bumpLast(eventId) {
    const k = getKpi();
    k.last = eventId;
    setKpi(k);
  }

  /* -------------------- FLUSH OFFLINE QUEUE -------------------- */

  async function flushQueue() {
    const q = getQueue();
    if (!q.length) {
      setStatus("No queued events.", true);
      return;
    }
    if (!isOnline()) {
      setStatus("Still offline. Can't flush.", false);
      return;
    }

    setStatus(`Flushing ${q.length} queued event(s)...`, true);

    const remaining = [];
    for (let i = 0; i < q.length; i++) {
      const payload = q[i];
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        remaining.push(payload);
      }
    }

    setQueue(remaining);
    setStatus(remaining.length ? `Flush done. Remaining queued: ${remaining.length}` : "Flush done. Queue cleared.", true);
  }

  window.addEventListener("online", () => flushQueue());

  /* -------------------- EVENTS: VOTE / SPIN / STATE RESULT -------------------- */

  async function saveVote() {
    const voterName  = document.getElementById("voterName").value.trim();
    const voterPhone = document.getElementById("voterPhone").value.trim();
    const state      = document.getElementById("state").value;
    const candidate  = document.getElementById("candidate").value;
    const party      = document.getElementById("party").value;
    const weight     = Number(document.getElementById("weight").value || 1);
    const note       = document.getElementById("note").value.trim();

    if (!state || !candidate || !party) {
      setStatus("Please select State, Candidate, and Party.", false);
      return;
    }

    const record = {
      action: "vote",
      user: {
        name: voterName,
        phone: voterPhone
      },
      vote: {
        state,
        candidate,
        party,
        weight
      },
      note
    };

    // Save to sheet "Votes"
    const r = await sendToSheets("Votes", record);

    // Local KPI
    const k = getKpi();
    k.votes = (k.votes || 0) + 1;
    k.last = r.event_id || k.last;
    setKpi(k);
  }

  async function saveSpinRound() {
    // Example spin logic (replace with your actual wheel logic)
    const prizes = ["₦200 Airtime", "₦500 Airtime", "₦1000 Airtime", "Try Again", "Mega Bonus"];
    const win = prizes[Math.floor(Math.random() * prizes.length)];

    const record = {
      action: "spin_round",
      round_id: uid("spin"),
      result: win,
      note: "Simulated spin round for testing"
    };

    const r = await sendToSheets("SpinRounds", record);

    const k = getKpi();
    k.spins = (k.spins || 0) + 1;
    k.last = r.event_id || k.last;
    setKpi(k);

    setStatus(`Spin saved. Result: ${win}`, true);
  }

  async function saveStateResult(state, candidate, votes) {
    if (!state || !candidate) {
      setStatus("Pick state + candidate for state result.", false);
      return;
    }

    const record = {
      action: "state_result",
      state,
      candidate,
      votes: Number(votes || 0)
    };

    const r = await sendToSheets("StateResults", record);
    setStatus(`State result saved (${state}). Event: ${r.event_id}`, true);
  }

  /* -------------------- INIT UI -------------------- */

  function fillSelect(id, items, getVal, getLabel) {
    const sel = document.getElementById(id);
    items.forEach(it => {
      const opt = document.createElement("option");
      opt.value = getVal(it);
      opt.textContent = getLabel(it);
      sel.appendChild(opt);
    });
  }

  function init() {
    // States
    const stateSel = document.getElementById("state");
    const stateSel2 = document.getElementById("state2");
    STATES.forEach(s => {
      const o1 = document.createElement("option"); o1.value = s; o1.textContent = s; stateSel.appendChild(o1);
      const o2 = document.createElement("option"); o2.value = s; o2.textContent = s; stateSel2.appendChild(o2);
    });

    // Candidates
    fillSelect("candidate", CANDIDATES, x => x.id, x => x.name);
    fillSelect("candidate2", CANDIDATES, x => x.id, x => x.name);

    // Parties
    fillSelect("party", PARTIES, x => x.id, x => `${x.code} — ${x.name}`);

    // Queue + KPI
    setQueue(getQueue());
    renderKpi();

    // Buttons
    document.getElementById("btnVote").addEventListener("click", saveVote);
    document.getElementById("btnSpin").addEventListener("click", saveSpinRound);
    document.getElementById("btnFlush").addEventListener("click", flushQueue);

    document.getElementById("btnStateSave").addEventListener("click", () => {
      const st = document.getElementById("state2").value;
      const cd = document.getElementById("candidate2").value;
      const vt = document.getElementById("stateVotes").value;
      saveStateResult(st, cd, vt);
    });

    // Optional: log page open
    sendToSheets("RawEvents", { action: "page_open" }, { queueOnly: false });

    setStatus("Ready. Connected to Sheets.", true);
  }

  init();
</script>

</body>
</html>
